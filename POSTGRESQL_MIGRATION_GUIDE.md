# PostgreSQL Migration Guide

## Overview
This guide will help you migrate your Laravel restaurant API from SQLite to PostgreSQL without losing any data.

## Benefits of PostgreSQL
- **Better Performance**: Handles concurrent connections much better
- **Production Ready**: More robust for production environments
- **Advanced Features**: Better data types, indexing, and query optimization
- **No File Permission Issues**: No more SQLite read-only database problems
- **Better on Render**: PostgreSQL is well-supported and optimized on Render

## Migration Steps

### 1. **Backup Your Current Data (Optional)**
If you want to keep your current SQLite data as a backup:
```bash
# Copy your current database
cp database/sqlite/database.sqlite database/sqlite/database_backup.sqlite
```

### 2. **Deploy with PostgreSQL**
The migration is automatic when you deploy with the new configuration:

1. **Push your changes**:
   ```bash
   git add .
   git commit -m "Migrate from SQLite to PostgreSQL"
   git push origin master
   ```

2. **Deploy on Render**:
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Create a new deployment using the updated `render.yaml`
   - Render will automatically:
     - Create a PostgreSQL database service
     - Deploy your Laravel application
     - Run migrations to create tables
     - Seed the database with your restaurant data

### 3. **What Happens During Migration**

#### **Database Setup**:
- PostgreSQL 15 database is created
- Database name: `shami_restaurant`
- User: `shami_user`
- Password: Auto-generated by Render

#### **Data Migration**:
- All your existing migrations will run on PostgreSQL
- The `MockDataSeeder` will populate the database with the same data:
  - 17+ users (admin, managers, cashiers, customers)
  - 12 restaurant tables
  - 17+ dishes across 10 categories
  - Sample orders, reservations, and reviews

#### **No Data Loss**:
- All your restaurant data will be recreated
- Same user accounts and passwords
- Same menu items and categories
- Same table configurations

### 4. **Default Accounts (Same as Before)**
After migration, you can use these accounts:

#### **Admin Account**:
- **Email**: `admin@shami-restaurant.com`
- **Password**: `admin123`

#### **Manager Accounts**:
- **Email**: `manager1@shami-restaurant.com`
- **Password**: `manager123`
- **Email**: `mimoali@shami-restaurant.com`
- **Password**: `manager123`

#### **Customer Accounts**:
- **Email**: `ahmad.hamwi@customer.com`
- **Password**: `customer123`
- **Email**: `rana.kheir@customer.com`
- **Password**: `customer123`

### 5. **Configuration Changes Made**

#### **Database Configuration**:
```php
// config/database.php
'default' => env('DB_CONNECTION', 'pgsql'), // Changed from 'sqlite'
```

#### **Docker Configuration**:
```dockerfile
# Added PostgreSQL support
RUN apk add --no-cache postgresql-dev
RUN docker-php-ext-install pdo_pgsql
```

#### **Render Configuration**:
```yaml
# Added PostgreSQL service
- type: pserv
  name: shami-restaurant-db
  dockerImage: postgres:15
```

### 6. **Testing the Migration**

After deployment, test these endpoints:

1. **Health Check**:
   ```
   GET https://your-app.onrender.com/api/menu/recommendations
   ```

2. **Login Test**:
   ```bash
   curl -X POST https://your-app.onrender.com/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email": "admin@shami-restaurant.com", "password": "admin123"}'
   ```

3. **Menu Test**:
   ```
   GET https://your-app.onrender.com/api/menu/categories
   ```

### 7. **Rollback Plan (If Needed)**

If you need to rollback to SQLite:

1. **Revert configuration**:
   ```bash
   git revert <commit-hash>
   git push origin master
   ```

2. **Update render.yaml** to remove PostgreSQL service

3. **Redeploy** with SQLite configuration

### 8. **Performance Improvements**

With PostgreSQL, you'll notice:
- **Faster queries** on large datasets
- **Better concurrent user handling**
- **No more database lock issues**
- **Improved reliability**

### 9. **Monitoring**

Monitor your PostgreSQL database in Render dashboard:
- **Connection count**
- **Query performance**
- **Database size**
- **Memory usage**

### 10. **Cost Considerations**

- **PostgreSQL Service**: ~$7/month (starter plan)
- **Web Service**: ~$7/month (starter plan)
- **Total**: ~$14/month for both services

This is still very affordable for a production restaurant API.

## Troubleshooting

### **Connection Issues**:
- Check that PostgreSQL service is running
- Verify environment variables are set correctly
- Check Render service logs

### **Migration Issues**:
- Check Laravel logs for migration errors
- Verify database permissions
- Check if all required tables were created

### **Data Issues**:
- Verify seeder ran successfully
- Check if all users were created
- Verify menu data is present

## Support

For issues with:
- **PostgreSQL**: Check Render PostgreSQL service logs
- **Laravel**: Check application logs in Render dashboard
- **Migration**: Check Laravel migration logs

The migration should be seamless and automatic. Your restaurant API will be more robust and production-ready with PostgreSQL!
